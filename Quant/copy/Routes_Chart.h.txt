#pragma once

#include "HtmlHelpers.h"
#include "TradeDatabase.h"
#include <mutex>
#include <sstream>

inline void registerChartRoutes(httplib::Server& svr, TradeDatabase& db, std::mutex& dbMutex)
{
    // ========== GET /chart — Interactive visualization ==========
    svr.Get("/chart", [&](const httplib::Request&, httplib::Response& res) {
        std::ostringstream pg;
        pg << "<!DOCTYPE html><html><head><meta charset='utf-8'>"
              "<meta name='viewport' content='width=device-width,initial-scale=1'>"
              "<title>Chart - Quant</title><style>"
              "*{box-sizing:border-box;margin:0;padding:0;}"
              "body{font-family:'Segoe UI',monospace;background:#0d1117;color:#c9d1d9;overflow-x:hidden;}"
              "nav{background:#161b22;padding:10px 20px;border-bottom:1px solid #30363d;display:flex;gap:8px;flex-wrap:wrap;}"
              "nav a{color:#58a6ff;text-decoration:none;font-size:0.85em;padding:4px 8px;border-radius:4px;}"
              "nav a:hover{background:#21262d;}"
              ".wrap{display:flex;height:calc(100vh - 44px);}"
              ".sidebar{width:320px;min-width:320px;background:#161b22;border-right:1px solid #30363d;"
              "overflow-y:auto;padding:10px;font-size:0.82em;}"
              ".sidebar h3{color:#f0883e;margin:8px 0 4px 0;font-size:0.9em;border-bottom:1px solid #21262d;padding-bottom:3px;}"
              ".sidebar label{display:inline-block;width:100px;color:#8b949e;font-size:0.8em;}"
              ".sidebar input,.sidebar select{background:#0d1117;border:1px solid #30363d;color:#c9d1d9;padding:3px 5px;"
              "border-radius:3px;font-family:inherit;font-size:0.85em;width:100px;margin:1px 0;}"
              ".sidebar input:focus,.sidebar select:focus{border-color:#58a6ff;outline:none;}"
              ".sidebar .row{display:flex;align-items:center;margin:2px 0;}"
              ".canvas-wrap{flex:1;position:relative;overflow:hidden;}"
              "canvas{display:block;width:100%;height:100%;}"
              ".tooltip{position:absolute;background:#161b22ee;border:1px solid #30363d;border-radius:6px;padding:6px 10px;"
              "font-size:0.78em;color:#c9d1d9;pointer-events:none;display:none;white-space:pre;z-index:10;}"
              ".legend{position:absolute;top:8px;right:8px;background:#161b22dd;border:1px solid #30363d;border-radius:6px;"
              "padding:8px 12px;font-size:0.75em;z-index:5;}"
              ".legend div{display:flex;align-items:center;gap:6px;margin:2px 0;}"
              ".legend span.sw{display:inline-block;width:24px;height:3px;border-radius:1px;}"
              ".tabs{display:flex;gap:0;margin-bottom:8px;}"
              ".tabs button{flex:1;background:#0d1117;border:1px solid #30363d;color:#8b949e;padding:5px;cursor:pointer;"
              "font-family:inherit;font-size:0.8em;border-radius:0;}"
              ".tabs button:first-child{border-radius:4px 0 0 4px;}"
              ".tabs button:last-child{border-radius:0 4px 4px 0;}"
              ".tabs button.active{background:#1f6feb;color:#fff;border-color:#1f6feb;}"
              ".mode-panel{display:none;}.mode-panel.active{display:block;}"
              ".stats{display:flex;flex-wrap:wrap;gap:4px;margin:6px 0;}"
              ".stats div{background:#0d1117;border:1px solid #21262d;border-radius:4px;padding:3px 6px;font-size:0.75em;}"
              ".stats .lbl{color:#8b949e;}.stats .val{color:#f0883e;}"
              "button.action{background:#238636;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;"
              "font-family:inherit;font-size:0.8em;width:100%;margin:4px 0;}"
              "button.action:hover{background:#2ea043;}"
              ".filter-row{margin:4px 0;}.filter-row label{width:auto;margin-right:6px;}"
              ".filter-row input[type=checkbox]{width:auto;margin-right:2px;}"
              "</style></head><body>";
        pg << "<nav>"
              "<a href='/'>Dashboard</a><a href='/trades'>Trades</a><a href='/wallet'>Wallet</a>"
              "<a href='/portfolio'>Portfolio</a><a href='/market-entry'>Entry Calc</a>"
              "<a href='/serial-generator'>Serial Gen</a><a href='/exit-strategy'>Exit Calc</a>"
              "<a href='/entry-points'>Entry Points</a><a href='/pending-exits'>Pending Exits</a>"
              "<a href='/chart' style='color:#d2a8ff;font-weight:bold;'>&#9733; Chart</a>"
              "</nav>";
        pg << "<div class='wrap'><div class='sidebar' id='sidebar'>"
              "<div class='tabs' id='modeTabs'>"
              "<button class='active' data-mode='portfolio'>Portfolio</button>"
              "<button data-mode='entry'>Entry Calc</button>"
              "<button data-mode='serial'>Serial Gen</button></div>";
        // portfolio panel
        pg << "<div class='mode-panel active' id='panel-portfolio'>"
              "<h3>Existing Data</h3>"
              "<button class='action' onclick='loadPortfolio()'>Refresh Data</button>"
              "<div id='portfolio-symbols'></div>"
              "<div class='filter-row' id='portfolio-filters'></div>"
              "<div class='stats' id='portfolio-stats'></div></div>";
        // entry calc panel
        pg << "<div class='mode-panel' id='panel-entry'><h3>Market Entry (Live)</h3>"
              "<div class='row'><label>Symbol</label><input id='e_symbol' value='BTC'></div>"
              "<div class='row'><label>Price</label><input id='e_price' type='number' step='any' value='100000'></div>"
              "<div class='row'><label>Quantity</label><input id='e_qty' type='number' step='any' value='1'></div>"
              "<div class='row'><label>Levels</label><input id='e_levels' type='number' value='4'></div>"
              "<div class='row'><label>Risk</label><input id='e_risk' type='number' step='any' value='0.5'></div>"
              "<div class='row'><label>Steepness</label><input id='e_steepness' type='number' step='any' value='6'></div>"
              "<div class='row'><label>Fee Hedging</label><input id='e_feeHedging' type='number' step='any' value='2'></div>"
              "<div class='row'><label>Pump</label><input id='e_pump' type='number' step='any' value='1000'></div>"
              "<div class='row'><label>Symbols</label><input id='e_symCount' type='number' value='1'></div>"
              "<div class='row'><label>Coeff K</label><input id='e_coeffK' type='number' step='any' value='0'></div>"
              "<div class='row'><label>Fee Spread</label><input id='e_feeSpread' type='number' step='any' value='5'></div>"
              "<div class='row'><label>Delta Time</label><input id='e_deltaTime' type='number' step='any' value='1'></div>"
              "<div class='row'><label>Surplus</label><input id='e_surplus' type='number' step='any' value='0.02'></div>"
              "<div class='row'><label>Max Risk</label><input id='e_maxRisk' type='number' step='any' value='0'></div>"
              "<div class='row'><label>Min Risk</label><input id='e_minRisk' type='number' step='any' value='0'></div>"
              "<div class='row'><label>Direction</label><select id='e_isShort'>"
              "<option value='0'>LONG</option><option value='1'>SHORT</option></select></div>"
              "<div class='row'><label>Funding</label><select id='e_fundMode'>"
              "<option value='1'>Pump only</option><option value='2'>Pump+Wallet</option></select></div>"
              "<div class='row'><label>Range Above</label><input id='e_rangeAbove' type='number' step='any' value='0'></div>"
              "<div class='row'><label>Range Below</label><input id='e_rangeBelow' type='number' step='any' value='0'></div>"
              "<h3>Parameter Models</h3>"
              "<div class='row'><label>Name</label><input id='e_modelName' type='text' value=''></div>"
              "<div class='row'><select id='e_modelSelect' style='width:150px;'><option value=''>-- load --</option></select>"
              "<button type='button' class='action' style='width:auto;margin-left:4px;padding:3px 6px;' onclick='loadModel(\"e\")'>Load</button></div>"
              "<div class='row' style='gap:4px;'>"
              "<button type='button' class='action' style='width:auto;background:#1f6feb;' onclick='saveModel(\"e\")'>Save</button>"
              "<button type='button' class='action' style='width:auto;background:#da3633;' onclick='deleteModel(\"e\")'>Delete</button></div>"
              "<div class='stats' id='entry-stats'></div>"
              "<button class='action' id='saveEntryBtn' style='display:none;background:#1f6feb;'>Save Entry Points</button></div>";
        // serial gen panel
        pg << "<div class='mode-panel' id='panel-serial'><h3>Serial Gen (Live)</h3>"
              "<div class='row'><label>Symbol</label><input id='s_symbol' value='BTC'></div>"
              "<div class='row'><label>Price</label><input id='s_price' type='number' step='any' value='100000'></div>"
              "<div class='row'><label>Quantity</label><input id='s_qty' type='number' step='any' value='1'></div>"
              "<div class='row'><label>Levels</label><input id='s_levels' type='number' value='4'></div>"
              "<div class='row'><label>Risk</label><input id='s_risk' type='number' step='any' value='0.5'></div>"
              "<div class='row'><label>Steepness</label><input id='s_steepness' type='number' step='any' value='6'></div>"
              "<div class='row'><label>Fee Hedging</label><input id='s_feeHedging' type='number' step='any' value='2'></div>"
              "<div class='row'><label>Pump</label><input id='s_pump' type='number' step='any' value='1000'></div>"
              "<div class='row'><label>Symbols</label><input id='s_symCount' type='number' value='1'></div>"
              "<div class='row'><label>Coeff K</label><input id='s_coeffK' type='number' step='any' value='0'></div>"
              "<div class='row'><label>Fee Spread</label><input id='s_feeSpread' type='number' step='any' value='5'></div>"
              "<div class='row'><label>Delta Time</label><input id='s_deltaTime' type='number' step='any' value='1'></div>"
              "<div class='row'><label>Surplus</label><input id='s_surplus' type='number' step='any' value='0.02'></div>"
              "<div class='row'><label>Max Risk</label><input id='s_maxRisk' type='number' step='any' value='0'></div>"
              "<div class='row'><label>Min Risk</label><input id='s_minRisk' type='number' step='any' value='0'></div>"
              "<div class='row'><label>Direction</label><select id='s_isShort'>"
              "<option value='0'>LONG</option><option value='1'>SHORT</option></select></div>"
              "<div class='row'><label>Funding</label><select id='s_fundMode'>"
              "<option value='1'>Pump only</option><option value='2'>Pump+Wallet</option></select></div>"
              "<div class='row'><label>Stop Losses</label><select id='s_genSL'>"
              "<option value='0'>No</option><option value='1'>Yes</option></select></div>"
              "<div class='row'><label>Range Above</label><input id='s_rangeAbove' type='number' step='any' value='0'></div>"
              "<div class='row'><label>Range Below</label><input id='s_rangeBelow' type='number' step='any' value='0'></div>"
              "<h3>Parameter Models</h3>"
              "<div class='row'><label>Name</label><input id='s_modelName' type='text' value=''></div>"
              "<div class='row'><select id='s_modelSelect' style='width:150px;'><option value=''>-- load --</option></select>"
              "<button type='button' class='action' style='width:auto;margin-left:4px;padding:3px 6px;' onclick='loadModel(\"s\")'>Load</button></div>"
              "<div class='row' style='gap:4px;'>"
              "<button type='button' class='action' style='width:auto;background:#1f6feb;' onclick='saveModel(\"s\")'>Save</button>"
              "<button type='button' class='action' style='width:auto;background:#da3633;' onclick='deleteModel(\"s\")'>Delete</button></div>"
              "<div class='stats' id='serial-stats'></div>"
              "<button class='action' id='saveSerialBtn' style='display:none;background:#1f6feb;'>Save Entry Points</button></div>";
        pg << "</div>"; // sidebar
        pg << "<div class='canvas-wrap' id='canvasWrap'>"
              "<canvas id='chart'></canvas>"
              "<div class='tooltip' id='tip'></div>"
              "<div class='legend' id='legend'>"
              "<div><span class='sw' style='background:#58a6ff'></span> Entry Price</div>"
              "<div><span class='sw' style='background:#3fb950'></span> Take Profit</div>"
              "<div><span class='sw' style='background:#f85149'></span> Stop Loss</div>"
              "<div><span class='sw' style='background:#f0883e'></span> Break Even</div>"
              "<div><span class='sw' style='background:#d29922'></span> Current Price</div>"
              "<div><span class='sw' style='background:#8b949e'></span> Pending Exit</div>"
              "</div></div></div>";
        // JavaScript - split into multiple strings for MSVC
        pg << "<script>\n(function(){\n'use strict';\n";
        pg << "var $=function(id){return document.getElementById(id);};\n"
              "var canvas=$('chart'),ctx=canvas.getContext('2d');\n"
              "var tip=$('tip'),wrap=$('canvasWrap');\n"
              "var W,H,dpr,currentMode='portfolio';\n"
              "var chartData=[],priceMin=0,priceMax=1;\n"
              "var PAD_L=90,PAD_R=30,PAD_T=30,PAD_B=30;\n"
              "var lastEntryResult=null,lastSerialResult=null;\n";
        pg << "function resize(){dpr=window.devicePixelRatio||1;"
              "W=wrap.clientWidth;H=wrap.clientHeight;"
              "canvas.width=W*dpr;canvas.height=H*dpr;"
              "canvas.style.width=W+'px';canvas.style.height=H+'px';"
              "ctx.setTransform(dpr,0,0,dpr,0,0);draw();}\n"
              "window.addEventListener('resize',resize);\n";
        pg << "function priceToY(p){var r=priceMax-priceMin;if(r<=0)r=1;"
              "return PAD_T+(1-(p-priceMin)/r)*(H-PAD_T-PAD_B);}\n"
              "function yToPrice(y){var r=priceMax-priceMin;if(r<=0)r=1;"
              "return priceMin+(1-(y-PAD_T)/(H-PAD_T-PAD_B))*r;}\n"
              "function fp(p){if(Math.abs(p)>=1)return p.toFixed(2);"
              "if(Math.abs(p)>=0.01)return p.toFixed(4);return p.toFixed(8);}\n";
        // draw function
        pg << "function draw(){ctx.clearRect(0,0,W,H);ctx.fillStyle='#0d1117';ctx.fillRect(0,0,W,H);\n"
              "if(!chartData.length){ctx.fillStyle='#484f58';ctx.font='14px monospace';"
              "ctx.textAlign='center';ctx.fillText('Select a mode and load data',W/2,H/2);return;}\n"
              "var prices=chartData.map(function(d){return d.price;}).filter(function(p){return p>0&&isFinite(p);});\n"
              "if(!prices.length)return;\n"
              "var pMin=Math.min.apply(null,prices),pMax=Math.max.apply(null,prices);\n"
              "var pad=(pMax-pMin)*0.1||pMax*0.1||1;priceMin=pMin-pad;priceMax=pMax+pad;\n";
        pg << "var gs=10,gst=(priceMax-priceMin)/gs;\n"
              "ctx.strokeStyle='#21262d';ctx.lineWidth=1;ctx.font='10px monospace';ctx.fillStyle='#484f58';ctx.textAlign='right';\n"
              "for(var i=0;i<=gs;i++){var p=priceMin+gst*i,y=priceToY(p);"
              "ctx.beginPath();ctx.moveTo(PAD_L,y);ctx.lineTo(W-PAD_R,y);ctx.stroke();"
              "ctx.fillText(fp(p),PAD_L-4,y+3);}\n";
        pg << "var groups={};chartData.forEach(function(d){var k=d.group||'default';"
              "if(!groups[k])groups[k]=[];groups[k].push(d);});\n"
              "var gk=Object.keys(groups),barW=Math.max(20,Math.min(80,(W-PAD_L-PAD_R)/(gk.length+1))),barGap=8;\n";
        pg << "gk.forEach(function(g,gi){var items=groups[g];"
              "var cx=PAD_L+barW/2+gi*(barW+barGap)+barGap;if(cx>W-PAD_R)return;\n"
              "ctx.fillStyle='#8b949e';ctx.textAlign='center';ctx.font='10px monospace';ctx.fillText(g,cx,H-8);\n"
              "items.forEach(function(d){var y=priceToY(d.price);if(y<PAD_T||y>H-PAD_B)return;\n"
              "ctx.save();ctx.strokeStyle=d.color;ctx.lineWidth=d.width||2;\n"
              "if(d.dash)ctx.setLineDash(d.dash);else ctx.setLineDash([]);\n"
              "var x1=cx-barW/2+2,x2=cx+barW/2-2;\n"
              "ctx.beginPath();ctx.moveTo(x1,y);ctx.lineTo(x2,y);ctx.stroke();\n"
              "ctx.fillStyle=d.color;ctx.textAlign='left';ctx.font='9px monospace';\n"
              "ctx.fillText(d.shortLabel||d.type,x2+3,y+3);ctx.restore();});\n";
        pg << "var ei=items.find(function(d){return d.type==='Entry';});\n"
              "if(ei&&ei.funding>0){var mf=Math.max.apply(null,chartData.filter(function(d){return d.funding>0;}).map(function(d){return d.funding;}).concat([1]));\n"
              "var maxBH=Math.max(80,(H-PAD_T-PAD_B)*0.18),bh=(ei.funding/mf)*maxBH,ey=priceToY(ei.price);\n"
              "var alpha=(0.08+0.10*(ei.funding/mf)).toFixed(2);\n"
              "ctx.fillStyle='rgba(88,166,255,'+alpha+')';ctx.fillRect(cx-barW/2+2,ey-bh,barW-4,bh);\n"
              "ctx.fillStyle='#58a6ffcc';ctx.textAlign='center';ctx.font='bold 9px monospace';\n"
              "var pct=ei.fundPct?ei.fundPct.toFixed(1)+'%':'';\n"
              "ctx.fillText(pct,cx,ey-bh-10);\n"
              "ctx.font='8px monospace';ctx.fillStyle='#58a6ff88';\n"
              "ctx.fillText(fp(ei.qty||0)+' qty',cx,ey-bh-1);}});\n";
        pg << "var cp=chartData.find(function(d){return d.type==='Current';});\n"
              "if(cp){var cy=priceToY(cp.price);ctx.save();ctx.strokeStyle='#d29922';ctx.lineWidth=1.5;\n"
              "ctx.setLineDash([8,4]);ctx.beginPath();ctx.moveTo(PAD_L,cy);ctx.lineTo(W-PAD_R,cy);ctx.stroke();\n"
              "ctx.fillStyle='#d29922';ctx.textAlign='left';ctx.font='11px monospace';\n"
              "ctx.fillText('Current: '+fp(cp.price),PAD_L+4,cy-6);ctx.restore();}}\n";
        // tooltip
        pg << "canvas.addEventListener('mousemove',function(e){\n"
              "var r=canvas.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;\n"
              "var closest=null,minD=999;\n"
              "chartData.forEach(function(d){if(d.type==='Current')return;\n"
              "var dist=Math.abs(priceToY(d.price)-my);if(dist<minD&&dist<12){minD=dist;closest=d;}});\n"
              "if(closest){var ln=closest.label+'\\nPrice: '+fp(closest.price);\n"
              "if(closest.fundPct)ln+='\\nFund: '+closest.fundPct.toFixed(1)+'%';\n"
              "if(closest.qty)ln+='\\nQty: '+fp(closest.qty);\n"
              "if(closest.funding)ln+='\\nFunding: '+fp(closest.funding);\n"
              "if(closest.feeCost)ln+='\\nFee Cost: '+fp(closest.feeCost);\n"
              "tip.textContent=ln;tip.style.display='block';\n"
              "tip.style.left=(mx+14)+'px';tip.style.top=(my-10)+'px';\n"
              "}else{tip.style.display='none';}});\n"
              "canvas.addEventListener('mouseleave',function(){tip.style.display='none';});\n";
        // tabs
        pg << "$('modeTabs').addEventListener('click',function(e){\n"
              "if(e.target.tagName!=='BUTTON')return;\n"
              "document.querySelectorAll('#modeTabs button').forEach(function(b){b.classList.remove('active');});\n"
              "e.target.classList.add('active');\n"
              "document.querySelectorAll('.mode-panel').forEach(function(p){p.classList.remove('active');});\n"
              "currentMode=e.target.dataset.mode;\n"
              "$('panel-'+currentMode).classList.add('active');\n"
              "if(currentMode==='portfolio')loadPortfolio();});\n";
        // portfolio
        pg << "var pTrades=[],pEntries=[],pPending=[],pHorizons={},symFilter={};\n"
              "function loadPortfolio(){\n"
              "Promise.all([fetch('/api/trades').then(function(r){return r.json();}),\n"
              "fetch('/api/entry-points').then(function(r){return r.json();}),\n"
              "fetch('/api/pending-exits').then(function(r){return r.json();})])\n"
              ".then(function(arr){pTrades=arr[0];pEntries=arr[1];pPending=arr[2];pHorizons={};\n"
              "var buys=pTrades.filter(function(t){return t.type==='Buy';});\n"
              "var chain=Promise.resolve();\n"
              "buys.forEach(function(t){chain=chain.then(function(){\n"
              "return fetch('/api/horizons?tradeId='+t.id).then(function(r){return r.json();}).then(function(h){\n"
              "if(h.length>0)pHorizons[t.id]=h;});});});\n"
              "chain.then(function(){\n";
        pg << "var syms=[];pTrades.forEach(function(t){if(syms.indexOf(t.symbol)<0)syms.push(t.symbol);});\n"
              "pEntries.forEach(function(e){if(syms.indexOf(e.symbol)<0)syms.push(e.symbol);});\n"
              "var fd=$('portfolio-filters');fd.innerHTML='<h3>Symbols</h3>';\n"
              "syms.forEach(function(s){if(!(s in symFilter))symFilter[s]=true;\n"
              "var lbl=document.createElement('label');lbl.className='filter-row';\n"
              "var cb=document.createElement('input');cb.type='checkbox';cb.checked=symFilter[s];\n"
              "cb.addEventListener('change',function(){symFilter[s]=cb.checked;drawP();});\n"
              "lbl.appendChild(cb);lbl.appendChild(document.createTextNode(' '+s));fd.appendChild(lbl);});\n"
              "var sd=$('portfolio-stats');sd.innerHTML="
              "'<div><span class=lbl>Trades: </span><span class=val>'+buys.length+'</span></div>'+\n"
              "'<div><span class=lbl>Entries: </span><span class=val>'+pEntries.filter(function(e){return !e.traded;}).length+'</span></div>'+\n"
              "'<div><span class=lbl>Pending: </span><span class=val>'+pPending.length+'</span></div>';\n"
              "drawP();});});}\n";
        // drawP
        pg << "function drawP(){chartData=[];\n"
              "var buys=pTrades.filter(function(t){return t.type==='Buy'&&symFilter[t.symbol]!==false;});\n"
              "buys.forEach(function(t){var g='#'+t.id+' '+t.symbol;\n"
              "chartData.push({label:'Entry #'+t.id+' '+t.symbol,price:t.price,color:'#58a6ff',type:'Entry',"
              "group:g,shortLabel:'E',width:2.5,qty:t.remaining});\n"
              "if(t.tpPrice>0)chartData.push({label:'TP #'+t.id,price:t.tpPrice,color:'#3fb950',type:'TP',"
              "group:g,shortLabel:'TP',width:2,dash:[6,3]});\n"
              "if(t.slPrice>0)chartData.push({label:'SL #'+t.id+(t.slActive?' ON':' OFF'),price:t.slPrice,"
              "color:t.slActive?'#f85149':'#f8514966',type:'SL',group:g,shortLabel:'SL',width:2,"
              "dash:t.slActive?[]:[4,4]});\n"
              "if(pHorizons[t.id])pHorizons[t.id].forEach(function(h){\n"
              "if(h.tpPrice>0)chartData.push({label:'H'+h.index+' TP',price:h.tpPrice,color:'#3fb95088',"
              "type:'HTP',group:g,shortLabel:'H'+h.index,width:1.5,dash:[4,2]});\n"
              "if(h.slPrice>0)chartData.push({label:'H'+h.index+' SL',price:h.slPrice,color:'#f8514988',"
              "type:'HSL',group:g,shortLabel:'H'+h.index,width:1.5,dash:[4,2]});});});\n";
        pg << "pEntries.filter(function(e){return !e.traded&&symFilter[e.symbol]!==false;}).forEach(function(ep){\n"
              "var g='EP#'+ep.id+' '+ep.symbol;\n"
              "chartData.push({label:'EntryPt #'+ep.id+' L'+ep.level,price:ep.entry,color:'#58a6ff',"
              "type:'Entry',group:g,shortLabel:'E',width:2,dash:[8,3],qty:ep.qty,funding:ep.funding||0,"
              "feeCost:(ep.breakEven>0&&ep.entry>0)?(ep.breakEven-ep.entry)*ep.qty:0});\n"
              "if(ep.breakEven>0)chartData.push({label:'BE #'+ep.id,price:ep.breakEven,color:'#f0883e',"
              "type:'BE',group:g,shortLabel:'BE',width:1.5,dash:[3,3]});\n"
              "if(ep.tp>0)chartData.push({label:'TP #'+ep.id,price:ep.tp,color:'#3fb950',"
              "type:'TP',group:g,shortLabel:'TP',width:1.5,dash:[6,3]});\n"
              "if(ep.sl>0)chartData.push({label:'SL #'+ep.id,price:ep.sl,color:'#f85149',"
              "type:'SL',group:g,shortLabel:'SL',width:1.5,dash:[6,3]});});\n";
        pg << "pPending.filter(function(pe){return symFilter[pe.symbol]!==false;}).forEach(function(pe){\n"
              "var mt=pTrades.find(function(t){return t.id===pe.tradeId;});\n"
              "var g=mt?('#'+mt.id+' '+mt.symbol):('PE#'+pe.orderId);\n"
              "chartData.push({label:'PendExit #'+pe.orderId+' L'+pe.level,price:pe.trigger,"
              "color:'#8b949e',type:'Pend',group:g,shortLabel:'PX',width:1.5,dash:[3,5]});});\n"
              "draw();}\n";
        // entry calc
        pg << "var eTimer=null;\n"
              "function setupE(){var ids=['e_symbol','e_price','e_qty','e_levels','e_risk','e_steepness','e_feeHedging','e_pump',"
              "'e_symCount','e_coeffK','e_feeSpread','e_deltaTime','e_surplus','e_maxRisk','e_minRisk','e_isShort','e_fundMode','e_rangeAbove','e_rangeBelow'];\n"
              "ids.forEach(function(id){$(id).addEventListener('input',function(){\n"
              "clearTimeout(eTimer);eTimer=setTimeout(calcE,200);});});}\n";
        pg << "function calcE(){var body=new URLSearchParams({"
              "symbol:$('e_symbol').value,currentPrice:$('e_price').value,"
              "quantity:$('e_qty').value,levels:$('e_levels').value,"
              "risk:$('e_risk').value,steepness:$('e_steepness').value,feeHedgingCoefficient:$('e_feeHedging').value,"
              "portfolioPump:$('e_pump').value,symbolCount:$('e_symCount').value,"
              "coefficientK:$('e_coeffK').value,feeSpread:$('e_feeSpread').value,"
              "deltaTime:$('e_deltaTime').value,surplusRate:$('e_surplus').value,"
              "isShort:$('e_isShort').value,fundMode:$('e_fundMode').value,maxRisk:$('e_maxRisk').value,"
              "minRisk:$('e_minRisk').value,"
              "rangeAbove:$('e_rangeAbove').value,rangeBelow:$('e_rangeBelow').value});\n"
              "fetch('/api/calc/entry',{method:'POST',body:body}).then(function(r){return r.json();}).then(function(d){\n"
              "if(d.error)return;lastEntryResult=d;$('saveEntryBtn').style.display='block';chartData=[];\n"
              "chartData.push({label:'Current',price:d.currentPrice,color:'#d29922',type:'Current',group:'_'});\n"
              "var efs=parseFloat($('e_feeSpread').value)||0,efh=parseFloat($('e_feeHedging').value)||0,"
              "edt=parseFloat($('e_deltaTime').value)||1,efc=efs*efh*edt;\n"
              "$('entry-stats').innerHTML="
              "'<div><span class=lbl>OH: </span><span class=val>'+(d.overhead*100).toFixed(4)+'%</span></div>'+\n"
              "'<div><span class=lbl>Eff: </span><span class=val>'+(d.effective*100).toFixed(4)+'%</span></div>'+\n"
              "'<div><span class=lbl>Lvls: </span><span class=val>'+d.levels.length+'</span></div>'+\n"
              "'<div><span class=lbl>Spread: </span><span class=val>'+fp(efs)+'</span></div>'+\n"
              "'<div><span class=lbl>Hedging: </span><span class=val>'+fp(efh)+'</span></div>'+\n"
              "'<div><span class=lbl>Fee/Trade: </span><span class=val>'+fp(efc)+'</span></div>';\n"
              "d.levels.forEach(function(lv){var g='L'+lv.index;\n"
              "chartData.push({label:'L'+lv.index+' Entry',price:lv.entry,color:'#58a6ff',type:'Entry',"
              "group:g,shortLabel:'E',width:2.5,qty:lv.qty,funding:lv.funding,feeCost:(lv.breakEven-lv.entry)*lv.qty});\n"
              "chartData.push({label:'L'+lv.index+' BE',price:lv.breakEven,color:'#f0883e',type:'BE',"
              "group:g,shortLabel:'BE',width:1.5,dash:[3,3]});\n"
              "if(lv.tp>0)chartData.push({label:'L'+lv.index+' TP',price:lv.tp,color:'#3fb950',type:'TP',"
              "group:g,shortLabel:'TP',width:2,dash:[6,3]});\n"
              "if(lv.sl>0)chartData.push({label:'L'+lv.index+' SL',price:lv.sl,color:'#f85149',type:'SL',"
              "group:g,shortLabel:'SL',width:2,dash:[6,3]});});\n"
              "draw();}).catch(function(){});}\n";
        // serial calc
        pg << "var sTimer=null;\n"
              "function setupS(){var ids=['s_symbol','s_price','s_qty','s_levels','s_risk','s_steepness','s_feeHedging','s_pump',"
              "'s_symCount','s_coeffK','s_feeSpread','s_deltaTime','s_surplus','s_maxRisk','s_minRisk','s_isShort','s_fundMode','s_genSL','s_rangeAbove','s_rangeBelow'];\n"
              "ids.forEach(function(id){$(id).addEventListener('input',function(){\n"
              "clearTimeout(sTimer);sTimer=setTimeout(calcS,200);});});}\n";
        pg << "function calcS(){var body=new URLSearchParams({"
              "symbol:$('s_symbol').value,currentPrice:$('s_price').value,"
              "quantity:$('s_qty').value,levels:$('s_levels').value,"
              "risk:$('s_risk').value,steepness:$('s_steepness').value,"
              "feeHedgingCoefficient:$('s_feeHedging').value,portfolioPump:$('s_pump').value,"
              "symbolCount:$('s_symCount').value,coefficientK:$('s_coeffK').value,"
              "feeSpread:$('s_feeSpread').value,deltaTime:$('s_deltaTime').value,"
              "surplusRate:$('s_surplus').value,maxRisk:$('s_maxRisk').value,minRisk:$('s_minRisk').value,isShort:$('s_isShort').value,"
              "fundMode:$('s_fundMode').value,generateStopLosses:$('s_genSL').value,"
              "rangeAbove:$('s_rangeAbove').value,rangeBelow:$('s_rangeBelow').value});\n"
              "fetch('/api/calc/serial',{method:'POST',body:body}).then(function(r){return r.json();}).then(function(d){\n"
              "if(d.error)return;lastSerialResult=d;$('saveSerialBtn').style.display='block';chartData=[];\n"
              "chartData.push({label:'Current',price:d.currentPrice,color:'#d29922',type:'Current',group:'_'});\n"
              "var sfs=parseFloat($('s_feeSpread').value)||0,sfh=parseFloat($('s_feeHedging').value)||0,"
              "sdt=parseFloat($('s_deltaTime').value)||1,sfc=sfs*sfh*sdt;\n"
              "$('serial-stats').innerHTML="
              "'<div><span class=lbl>OH: </span><span class=val>'+(d.overhead*100).toFixed(4)+'%</span></div>'+\n"
              "'<div><span class=lbl>Eff: </span><span class=val>'+(d.effective*100).toFixed(4)+'%</span></div>'+\n"
              "'<div><span class=lbl>Lvls: </span><span class=val>'+d.levels.length+'</span></div>'+\n"
              "'<div><span class=lbl>Spread: </span><span class=val>'+fp(sfs)+'</span></div>'+\n"
              "'<div><span class=lbl>Hedging: </span><span class=val>'+fp(sfh)+'</span></div>'+\n"
              "'<div><span class=lbl>Fee/Trade: </span><span class=val>'+fp(sfc)+'</span></div>';\n"
              "d.levels.forEach(function(lv){var g='L'+lv.index;\n"
              "chartData.push({label:'L'+lv.index+' Entry',price:lv.entry,color:'#58a6ff',type:'Entry',"
              "group:g,shortLabel:'E',width:2.5,qty:lv.qty,funding:lv.funding,feeCost:(lv.breakEven-lv.entry)*lv.qty});\n"
              "chartData.push({label:'L'+lv.index+' BE',price:lv.breakEven,color:'#f0883e',type:'BE',"
              "group:g,shortLabel:'BE',width:1.5,dash:[3,3]});\n"
              "if(lv.tp>0)chartData.push({label:'L'+lv.index+' TP',price:lv.tp,color:'#3fb950',type:'TP',"
              "group:g,shortLabel:'TP',width:2,dash:[6,3]});\n"
              "if(lv.sl>0)chartData.push({label:'L'+lv.index+' SL',price:lv.sl,color:'#f85149',type:'SL',"
              "group:g,shortLabel:'SL',width:2,dash:[6,3]});});\n"
              "draw();}).catch(function(){});}\n";
        // save functions
        pg << "function saveEntry(){\n"
              "if(!lastEntryResult)return;\n"
              "var f=document.createElement('form');f.method='POST';f.action='/execute-entries';\n"
              "function add(n,v){var i=document.createElement('input');i.type='hidden';i.name=n;i.value=v;f.appendChild(i);}\n"
              "add('symbol',$('e_symbol').value);add('currentPrice',$('e_price').value);\n"
              "add('quantity',$('e_qty').value);add('risk',$('e_risk').value);\n"
              "add('isShort',$('e_isShort').value);add('fundMode',$('e_fundMode').value);\n"
              "add('levels',$('e_levels').value);add('steepness',$('e_steepness').value);add('feeHedgingCoefficient',$('e_feeHedging').value);\n"
              "add('portfolioPump',$('e_pump').value);add('symbolCount',$('e_symCount').value);\n"
              "add('coefficientK',$('e_coeffK').value);add('feeSpread',$('e_feeSpread').value);\n"
              "add('deltaTime',$('e_deltaTime').value);add('surplusRate',$('e_surplus').value);\n"
              "add('maxRisk',$('e_maxRisk').value);add('minRisk',$('e_minRisk').value);\n"
              "add('rangeAbove',$('e_rangeAbove').value);add('rangeBelow',$('e_rangeBelow').value);\n"
              "document.body.appendChild(f);f.submit();}\n";
        pg << "function saveSerial(){\n"
              "if(!lastSerialResult)return;var d=lastSerialResult;\n"
              "var f=document.createElement('form');f.method='POST';f.action='/save-serial';\n"
              "function add(n,v){var i=document.createElement('input');i.type='hidden';i.name=n;i.value=v;f.appendChild(i);}\n"
              "add('symbol',$('s_symbol').value);add('isShort',$('s_isShort').value);\n"
              "add('pump',$('s_pump').value);add('entryCount',d.levels.length);\n"
              "d.levels.forEach(function(lv){\n"
              "add('ep_'+lv.index,lv.entry);add('eq_'+lv.index,lv.qty);\n"
              "add('eb_'+lv.index,lv.breakEven);add('ef_'+lv.index,lv.funding);\n"
              "add('eov_'+lv.index,d.effective);add('etp_'+lv.index,lv.tp);\n"
              "add('esl_'+lv.index,lv.sl);});\n"
              "document.body.appendChild(f);f.submit();}\n";
        // param model functions
        pg << "var paramModels=[];\n"
              "function refreshModels(){\n"
              "fetch('/api/param-models').then(function(r){\n"
              "if(!r.ok)throw new Error('HTTP '+r.status);return r.json();}).then(function(arr){\n"
              "paramModels=arr;\n"
              "['e','s'].forEach(function(p){\n"
              "var sel=$(p+'_modelSelect');sel.innerHTML='<option value=\\'\\'>-- load --</option>';\n"
              "arr.forEach(function(m){var o=document.createElement('option');o.value=m.name;o.textContent=m.name;sel.appendChild(o);});\n"
              "});}).catch(function(e){console.warn('refreshModels:',e);});}\n";
        pg << "function saveModel(prefix){\n"
              "var name=$(prefix+'_modelName').value.trim();\n"
              "if(!name){alert('Enter a model name');return;}\n"
              "var body=new URLSearchParams({\n"
              "name:name,levels:$(prefix+'_levels').value,risk:$(prefix+'_risk').value,\n"
              "steepness:$(prefix+'_steepness').value,feeHedgingCoefficient:$(prefix+'_feeHedging').value,\n"
              "portfolioPump:$(prefix+'_pump').value,symbolCount:$(prefix+'_symCount').value,\n"
              "coefficientK:$(prefix+'_coeffK').value,feeSpread:$(prefix+'_feeSpread').value,\n"
              "deltaTime:$(prefix+'_deltaTime').value,surplusRate:$(prefix+'_surplus').value,\n"
              "maxRisk:$(prefix+'_maxRisk').value,minRisk:$(prefix+'_minRisk').value,\n"
              "isShort:$(prefix+'_isShort').value,\n"
              "fundMode:$(prefix+'_fundMode').value,\n"
              "rangeAbove:$(prefix+'_rangeAbove').value,rangeBelow:$(prefix+'_rangeBelow').value});\n"
              "if(prefix==='s'){body.set('generateStopLosses',$(prefix+'_genSL').value);}\n"
              "fetch('/api/param-models',{method:'POST',\n"
              "headers:{'Content-Type':'application/x-www-form-urlencoded'},\n"
              "body:body.toString()})\n"
              ".then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json();})\n"
              ".then(function(d){if(d.ok){refreshModels();\n"
              "var sel=$(prefix+'_modelSelect');\n"
              "setTimeout(function(){sel.value=name;},200);\n"
              "}else{alert('Save failed: '+(d.error||'unknown'));}})\n"
              ".catch(function(e){alert('Save error: '+e);});}\n";
        pg << "function loadModel(prefix){\n"
              "var name=$(prefix+'_modelSelect').value;\n"
              "if(!name)return;\n"
              "var m=paramModels.find(function(x){return x.name===name;});\n"
              "if(!m)return;\n"
              "$(prefix+'_levels').value=m.levels;\n"
              "$(prefix+'_risk').value=m.risk;\n"
              "$(prefix+'_steepness').value=m.steepness;\n"
              "$(prefix+'_feeHedging').value=m.feeHedgingCoefficient;\n"
              "$(prefix+'_pump').value=m.portfolioPump;\n"
              "$(prefix+'_symCount').value=m.symbolCount;\n"
              "$(prefix+'_coeffK').value=m.coefficientK;\n"
              "$(prefix+'_feeSpread').value=m.feeSpread;\n"
              "$(prefix+'_deltaTime').value=m.deltaTime;\n"
              "$(prefix+'_surplus').value=m.surplusRate;\n"
              "$(prefix+'_maxRisk').value=m.maxRisk;\n"
              "$(prefix+'_minRisk').value=m.minRisk;\n"
              "$(prefix+'_isShort').value=m.isShort?'1':'0';\n"
              "$(prefix+'_fundMode').value=m.fundMode;\n"
              "$(prefix+'_rangeAbove').value=m.rangeAbove;\n"
              "$(prefix+'_rangeBelow').value=m.rangeBelow;\n"
              "if(prefix==='s'&&$(prefix+'_genSL'))$(prefix+'_genSL').value=m.generateStopLosses?'1':'0';\n"
              "$(prefix+'_modelName').value=m.name;\n"
              "if(prefix==='e')calcE();else calcS();}\n";
        pg << "function deleteModel(prefix){\n"
              "var name=$(prefix+'_modelName').value.trim()||($(prefix+'_modelSelect').value);\n"
              "if(!name){alert('Enter or select a model name');return;}\n"
              "if(!confirm('Delete model: '+name+'?'))return;\n"
              "fetch('/api/param-models?name='+encodeURIComponent(name),{method:'DELETE'})\n"
              ".then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json();})\n"
              ".then(function(){$(prefix+'_modelName').value='';refreshModels();})\n"
              ".catch(function(e){alert('Delete error: '+e);});}\n";
        // init
        pg << "$('saveEntryBtn').addEventListener('click',saveEntry);\n"
              "$('saveSerialBtn').addEventListener('click',saveSerial);\n"
              "setupE();setupS();resize();loadPortfolio();refreshModels();\n"
              "})();\n</script></body></html>";
        res.set_content(pg.str(), "text/html");
    });
}
